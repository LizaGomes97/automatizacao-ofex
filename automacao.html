<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automa√ß√£o Drogasil - Execu√ß√£o</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }
      .container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .logo {
        color: #c41e3a;
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-icon {
        width: 40px;
        height: 40px;
        background-color: #c41e3a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 10px;
        font-size: 20px;
      }
      h1 {
        color: #333;
        font-size: 24px;
        margin: 0;
      }
      .info-panel {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .info-row {
        display: flex;
        margin-bottom: 10px;
      }
      .info-label {
        font-weight: bold;
        width: 120px;
        color: #555;
      }
      .info-value {
        flex: 1;
      }
      .button-panel {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }
      .btn-primary {
        background-color: #c41e3a;
        color: white;
        flex: 2;
      }
      .btn-primary:hover {
        background-color: #a01930;
      }
      .btn-secondary {
        background-color: #666;
        color: white;
        flex: 1;
      }
      .btn-secondary:hover {
        background-color: #555;
      }
      .log-container {
        border: 1px solid #ddd;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f5f5f5;
        font-family: monospace;
      }
      .log-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
      .log-item {
        margin-bottom: 5px;
        line-height: 1.4;
      }
      .log-time {
        color: #777;
        margin-right: 5px;
      }
      .footer {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #777;
      }
      .status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 14px;
        font-weight: bold;
      }
      .status-ready {
        background-color: #e0f0ff;
        color: #0066cc;
      }
      .status-running {
        background-color: #fff8e0;
        color: #cc7700;
      }
      .status-complete {
        background-color: #e0ffe0;
        color: #007700;
      }
      .status-error {
        background-color: #ffe0e0;
        color: #cc0000;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <div class="logo-icon">‚öïÔ∏è</div>
          AUTOMA√á√ÉO DROGASIL
        </div>
        <h1>Execu√ß√£o da Automa√ß√£o</h1>
      </div>

      <div class="info-panel">
        <div class="info-row">
          <div class="info-label">Status:</div>
          <div class="info-value">
            <span id="statusAutomacao" class="status status-ready">Pronto</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Matr√≠cula:</div>
          <div class="info-value" id="matriculaDisplay">-</div>
        </div>
        <div class="info-row">
          <div class="info-label">CPF:</div>
          <div class="info-value" id="cpfDisplay">-</div>
        </div>
      </div>

      <div class="button-panel">
        <button id="btnIniciar" class="btn-primary">Iniciar Automa√ß√£o</button>
        <button id="btnVoltar" class="btn-secondary">Voltar</button>
      </div>

      <div class="log-title">Logs da Execu√ß√£o:</div>
      <div id="logs" class="log-container"></div>

      <div class="footer">Sistema de Automa√ß√£o - Vers√£o 1.0</div>
    </div>

    <script>
      // Vari√°veis globais
      let simulacaoWindow = null;

      // Quando o documento estiver carregado
      document.addEventListener("DOMContentLoaded", function () {
        // Elementos da p√°gina
        const btnIniciar = document.getElementById("btnIniciar");
        const btnVoltar = document.getElementById("btnVoltar");
        const statusAutomacao = document.getElementById("statusAutomacao");
        const matriculaDisplay = document.getElementById("matriculaDisplay");
        const cpfDisplay = document.getElementById("cpfDisplay");
        const logsContainer = document.getElementById("logs");

        // Recupera os par√¢metros da URL
        const params = new URLSearchParams(window.location.search);
        const matricula =
          params.get("matricula") || localStorage.getItem("matricula") || "";
        const cpf = params.get("cpf") || "";

        // Exibe os valores na p√°gina
        matriculaDisplay.textContent = matricula || "-";
        cpfDisplay.textContent = cpf || "-";

        // Verifica se tem dados completos
        if (!matricula || !cpf) {
          adicionarLog("‚ö†Ô∏è Matr√≠cula ou CPF n√£o informados!");
          btnIniciar.disabled = true;
        } else {
          adicionarLog("‚úÖ Dados carregados, pronto para iniciar a automa√ß√£o.");
        }

        // Bot√£o de iniciar automa√ß√£o
        btnIniciar.addEventListener("click", async function () {
          // Desabilita o bot√£o durante a execu√ß√£o
          btnIniciar.disabled = true;
          statusAutomacao.textContent = "Em execu√ß√£o";
          statusAutomacao.className = "status status-running";

          try {
            // Executa a automa√ß√£o
            await executarAutomacao(matricula, cpf);

            statusAutomacao.textContent = "Conclu√≠do";
            statusAutomacao.className = "status status-complete";
          } catch (erro) {
            console.error("Erro ao executar automa√ß√£o:", erro);
            adicionarLog(`‚ùå Erro: ${erro.message}`);

            statusAutomacao.textContent = "Erro";
            statusAutomacao.className = "status status-error";
          } finally {
            // Reabilita o bot√£o ap√≥s a execu√ß√£o
            btnIniciar.disabled = false;
          }
        });

        // Bot√£o de voltar
        btnVoltar.addEventListener("click", function () {
          // Fecha a janela de simula√ß√£o se estiver aberta
          if (simulacaoWindow && !simulacaoWindow.closed) {
            simulacaoWindow.close();
          }

          window.location.href = "index.html";
        });
      });

      // Fun√ß√£o para executar a automa√ß√£o
      async function executarAutomacao(matricula, cpf) {
        // 1. Abre a p√°gina de simula√ß√£o
        await abrirPaginaSimulacao();

        // 2. Faz login com a matr√≠cula
        await fazerLogin(matricula);

        // 3. Busca o cliente por CPF
        await buscarClientePorCPF(cpf);

        // 4. Solicita impress√£o OFEX (em vers√µes futuras)

        // 5. Captura dados do cliente
        await capturarDadosCliente();
      }

      // Fun√ß√£o para abrir a p√°gina de simula√ß√£o
      async function abrirPaginaSimulacao() {
        adicionarLog("üåê Abrindo p√°gina da Drogasil...");

        // Fecha a janela anterior se existir
        if (simulacaoWindow && !simulacaoWindow.closed) {
          simulacaoWindow.close();
        }

        // Abre a p√°gina em uma nova janela
        simulacaoWindow = window.open(
          "simulacao-drogasil.html",
          "simulacaoDrogasil",
          "width=1024,height=768"
        );

        if (!simulacaoWindow) {
          throw new Error(
            "N√£o foi poss√≠vel abrir a p√°gina. Verifique se o bloqueador de pop-ups est√° desativado."
          );
        }

        // Aguarda a p√°gina carregar
        return new Promise((resolve) => {
          simulacaoWindow.onload = () => {
            adicionarLog("‚úÖ P√°gina aberta com sucesso!");
            resolve();
          };

          // Timeout para caso a p√°gina n√£o carregue corretamente
          setTimeout(() => {
            adicionarLog(
              "‚ö†Ô∏è Tempo de carregamento excedido, tentando continuar..."
            );
            resolve();
          }, 5000);
        });
      }

      // Fun√ß√£o para fazer login
      async function fazerLogin(matricula) {
        adicionarLog("üîë Realizando login com a matr√≠cula: " + matricula);

        // Verifica se a janela est√° dispon√≠vel
        if (!simulacaoWindow || simulacaoWindow.closed) {
          throw new Error("A janela da simula√ß√£o foi fechada!");
        }

        try {
          // Aguarda para garantir que a p√°gina est√° carregada
          await aguardar(1000);

          // Preenche o campo de matr√≠cula
          simulacaoWindow.document.getElementById("matricula").value =
            matricula;

          // Clica no bot√£o de login
          simulacaoWindow.document.getElementById("btnLogin").click();

          // Aguarda a transi√ß√£o de p√°gina
          await aguardar(1000);

          adicionarLog("‚úÖ Login realizado com sucesso!");
        } catch (erro) {
          adicionarLog(`‚ùå Erro ao fazer login: ${erro.message}`);
          throw erro;
        }
      }

      // Fun√ß√£o para buscar cliente por CPF
      async function buscarClientePorCPF(cpf) {
        adicionarLog(`üîç Buscando cliente com CPF: ${cpf}...`);

        // Verifica se a janela est√° dispon√≠vel
        if (!simulacaoWindow || simulacaoWindow.closed) {
          throw new Error("A janela da simula√ß√£o foi fechada!");
        }

        try {
          // Aguarda para garantir que a p√°gina est√° carregada
          await aguardar(1000);

          // Preenche o campo de CPF
          const campoCPF = simulacaoWindow.document.getElementById("cpf");
          if (!campoCPF) {
            throw new Error("Campo de CPF n√£o encontrado na p√°gina!");
          }
          campoCPF.value = cpf;

          // Clica no bot√£o de busca
          const botaoBuscar =
            simulacaoWindow.document.getElementById("btnBuscarCpf");
          if (!botaoBuscar) {
            throw new Error("Bot√£o de busca n√£o encontrado na p√°gina!");
          }
          botaoBuscar.click();

          // Aguarda o processamento da busca
          await aguardar(1000);

          adicionarLog("‚úÖ Busca por CPF realizada com sucesso!");
        } catch (erro) {
          adicionarLog(`‚ùå Erro ao buscar cliente: ${erro.message}`);
          throw erro;
        }
      }

      // Fun√ß√£o para capturar dados do cliente
      async function capturarDadosCliente() {
        adicionarLog("üìã Capturando dados do cliente...");

        // Verifica se a janela est√° dispon√≠vel
        if (!simulacaoWindow || simulacaoWindow.closed) {
          throw new Error("A janela da simula√ß√£o foi fechada!");
        }

        try {
          // Aguarda para garantir que a p√°gina est√° carregada
          await aguardar(1000);

          // Busca os clientes na lista
          const clienteItems =
            simulacaoWindow.document.querySelectorAll(".cliente-item");

          if (clienteItems.length === 0) {
            adicionarLog("‚ö†Ô∏è Nenhum cliente encontrado na lista.");
            return;
          }

          // Captura dados do primeiro cliente (poderia ser filtrado pelo CPF em uma vers√£o real)
          const primeiroCliente = clienteItems[0];
          const nomeCliente = primeiroCliente
            .querySelector("div:first-child")
            .textContent.trim();

          const statusElement = primeiroCliente.querySelector(
            ".status-aberto, .status-finalizado"
          );
          const statusCliente = statusElement
            ? statusElement.textContent.trim()
            : "Desconhecido";

          adicionarLog(`üìÑ Cliente encontrado: ${nomeCliente}`);
          adicionarLog(`üìÑ Status: ${statusCliente}`);

          // Clica no bot√£o "Atender" para este cliente
          const botaoAtender = primeiroCliente.querySelector(".btn-atender");
          if (botaoAtender) {
            adicionarLog("üîî Selecionando cliente para atendimento...");
            botaoAtender.click();
            await aguardar(1000);
            adicionarLog(
              "‚úÖ Cliente selecionado para atendimento com sucesso!"
            );
          }

          // Em uma vers√£o futura, aqui poderia ser adicionada a impress√£o OFEX
        } catch (erro) {
          adicionarLog(`‚ö†Ô∏è Erro ao capturar dados do cliente: ${erro.message}`);
          // N√£o lan√ßa erro aqui para permitir que a automa√ß√£o continue
        }
      }

      // Fun√ß√£o para aguardar um determinado tempo
      function aguardar(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // Fun√ß√£o para adicionar log
      function adicionarLog(mensagem) {
        const data = new Date();
        const horario = `${data.getHours().toString().padStart(2, "0")}:${data
          .getMinutes()
          .toString()
          .padStart(2, "0")}:${data.getSeconds().toString().padStart(2, "0")}`;

        const logItem = document.createElement("div");
        logItem.className = "log-item";
        logItem.innerHTML = `<span class="log-time">[${horario}]</span> ${mensagem}`;

        const logsContainer = document.getElementById("logs");
        logsContainer.appendChild(logItem);
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }
    </script>
  </body>
</html>
